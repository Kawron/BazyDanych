<!DOCTYPE html>
<html>
<head>
<title>raport.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<font size = 4>
<h1 id="laboratorium-1---karol-wrona">Laboratorium 1 - Karol Wrona</h1>
<h2 id="spis-tre%C5%9Bci">Spis Treści</h2>
<ol>
<li><a href="#1-tabele">Tabele</a></li>
<li><a href="#2-przyk%C5%82adowe-dane">Przykładowe dane</a></li>
<li><a href="#3-widoki">Widoki</a></li>
<li><a href="#4-procedury-pobieraj%C4%85ce-dane">Procedury pobierające dane</a></li>
<li><a href="#5-proceudry-modyfikuj%C4%85ce-dane">Procedury modyfikujące dane</a></li>
<li><a href="#6-triggery-dla-tabeli-log">Triggery dla tabeli log</a></li>
<li><a href="#7-kontrola-dost%C4%99pno%C5%9Bci-miejsc">Kontrola dostępności miejsc</a></li>
</ol>
<div style="page-break-after: always;"></div>
<h2 id="1-tabele">1. Tabele</h2>
<p>Tabela person</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> person
(
 person_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">generated</span> <span class="hljs-keyword">always</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">identity</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
, firstname <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>)
, lastname <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>)
, <span class="hljs-keyword">constraint</span> person_pk primary <span class="hljs-keyword">key</span>
 (
 person_id
 )
 <span class="hljs-keyword">enable</span>
);
</div></code></pre>
<pre class="hljs"><code><div>Tabela Trip
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> trip
(
 trip_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">generated</span> <span class="hljs-keyword">always</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">identity</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
, <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">100</span>)
, country <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>)
, trip_date <span class="hljs-built_in">date</span>
, max_no_places <span class="hljs-built_in">int</span>
, <span class="hljs-keyword">constraint</span> trip_pk primary <span class="hljs-keyword">key</span>
 (
 trip_id
 )
 <span class="hljs-keyword">enable</span>
);
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>Tabela Reservation</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> reservation
(
 reservation_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">generated</span> <span class="hljs-keyword">always</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">identity</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
, trip_id <span class="hljs-built_in">int</span>
, person_id <span class="hljs-built_in">int</span>
, <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
, no_places <span class="hljs-built_in">int</span>
, <span class="hljs-keyword">constraint</span> reservation_pk primary <span class="hljs-keyword">key</span>
 (
 reservation_id
 )
 <span class="hljs-keyword">enable</span>
);
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
(
 person_id
)
<span class="hljs-keyword">references</span> person
(
 person_id
)
<span class="hljs-keyword">enable</span>;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_fk2 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
(
 trip_id
)
<span class="hljs-keyword">references</span> trip
(
 trip_id
)
<span class="hljs-keyword">enable</span>;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> reservation
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> reservation_chk1 <span class="hljs-keyword">check</span>
(<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'n'</span>,<span class="hljs-string">'p'</span>,<span class="hljs-string">'c'</span>))
<span class="hljs-keyword">enable</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<h3 id="tabela-log">Tabela log</h3>
<p>Tabela dziennikująca zmiany w bazie danych. Dodano kolumne info, która opisuje jaka operacja została wykonana. Triggery znajdują się w <a href="#6-triggery-dla-tabeli-log">punkcie 6.</a></p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
(
 log_id <span class="hljs-built_in">int</span> <span class="hljs-keyword">generated</span> <span class="hljs-keyword">always</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">identity</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
, reservation_id <span class="hljs-built_in">int</span>
, log_date <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>
, no_places <span class="hljs-built_in">int</span>
, info <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>)
, <span class="hljs-keyword">constraint</span> log_pk primary <span class="hljs-keyword">key</span>
 (
 log_id
 )
 <span class="hljs-keyword">enable</span>
);
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">log</span>
<span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> log_fk1 <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">key</span>
(
    reservation_id
)
<span class="hljs-keyword">references</span> RESERVATION
(
    reservation_id
)
<span class="hljs-keyword">enable</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<h2 id="2-przyk%C5%82adowe-dane">2. Przykładowe dane</h2>
<p>Przykładowe osoby</p>
<pre class="hljs"><code><div><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'adam'</span>, <span class="hljs-string">'kowalski'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'jan'</span>, <span class="hljs-string">'nowak'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'maciek'</span>, <span class="hljs-string">'pomidor'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'adam'</span>, <span class="hljs-string">'cebula'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'zbigniew'</span>, <span class="hljs-string">'rzodkiewka'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'maria'</span>, <span class="hljs-string">'cukinia'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'ewa'</span>, <span class="hljs-string">'truskawka'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'jozef'</span>, <span class="hljs-string">'gruszka'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'helena'</span>, <span class="hljs-string">'ogorek'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> person (firstname, lastname)
<span class="hljs-keyword">values</span>(<span class="hljs-string">'jan'</span>, <span class="hljs-string">'malina'</span>);
</div></code></pre>
<p>Przykładowe wycieczki</p>
<pre class="hljs"><code><div><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip (<span class="hljs-keyword">name</span>, country, trip_date, max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'wycieczka do paryza'</span>,<span class="hljs-string">'francja'</span>,<span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2021-09-03'</span>,<span class="hljs-string">'yyyy-mm-dd'</span>),<span class="hljs-number">3</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip (<span class="hljs-keyword">name</span>, country, trip_date, max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'wycieczka do krakowa'</span>,<span class="hljs-string">'polska'</span>,<span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2022-12-05'</span>,<span class="hljs-string">'yyyy-mm-dd'</span>),<span class="hljs-number">5</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip (<span class="hljs-keyword">name</span>, country, trip_date, max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'wycieczka do berlina'</span>,<span class="hljs-string">'niemcy'</span>,<span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2022-10-09'</span>,<span class="hljs-string">'yyyy-mm-dd'</span>),<span class="hljs-number">3</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> trip (<span class="hljs-keyword">name</span>, country, trip_date, max_no_places)
<span class="hljs-keyword">values</span> (<span class="hljs-string">'wycieczka do rzymu'</span>,<span class="hljs-string">'wlochy'</span>,<span class="hljs-keyword">to_date</span>(<span class="hljs-string">'2022-06-01'</span>,<span class="hljs-string">'yyyy-mm-dd'</span>),<span class="hljs-number">2</span>);
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>Przykładowe rezerwacje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-string">'n'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'p'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'c'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'c'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'n'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'p'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>,<span class="hljs-number">7</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'p'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'p'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">4</span>,<span class="hljs-number">9</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'c'</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, no_places, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">values</span> (<span class="hljs-number">3</span>,<span class="hljs-number">10</span>,<span class="hljs-number">1</span>,<span class="hljs-string">'p'</span>);
</div></code></pre>
<h2 id="3-widoki">3. Widoki</h2>
<p>a) Widok Rezerwacji</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> reservations_view <span class="hljs-keyword">as</span>
    <span class="hljs-keyword">select</span> t.country, t.trip_date, t.name,
           p.firstname, p.lastname, r.reservation_id,
           r.no_places, r.status
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">join</span> trip t <span class="hljs-keyword">on</span> r.trip_id = t.trip_id
    <span class="hljs-keyword">join</span> person p <span class="hljs-keyword">on</span> r.person_id = p.person_id;
</div></code></pre>
<p>b) Widok wycieczek. Korzystam z pomocniczej funkcji <a href="#available"><em>available_places</em></a></p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> trips_view <span class="hljs-keyword">as</span>
    <span class="hljs-keyword">select</span> t.country, t.trip_date, t.name,
           t.max_no_places, available_places(t.trip_id) <span class="hljs-keyword">as</span> no_available_places
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">join</span> reservation r <span class="hljs-keyword">on</span> r.reservation_id = t.trip_id;
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>c) Widok dostępnych wycieczek</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> available_trips <span class="hljs-keyword">as</span>
    <span class="hljs-keyword">select</span> t.country, t.trip_date, t.name,
           t.max_no_places, available_places(t.trip_id) <span class="hljs-keyword">as</span> no_available_places
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">join</span> reservation r <span class="hljs-keyword">on</span> r.reservation_id = t.trip_id
    <span class="hljs-keyword">where</span> available_places(t.trip_id) &gt; <span class="hljs-number">0</span>;
</div></code></pre>
<h2 id="4-procedury-pobieraj%C4%85ce-dane">4. Procedury pobierające dane</h2>
<h2 id="typy-danych">Typy Danych</h2>
<p>Typ reprezentujący rezerwacje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> reservation_type <span class="hljs-keyword">as</span> <span class="hljs-keyword">OBJECT</span>
(
  country <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
  trip_date <span class="hljs-built_in">date</span>,
  trip_name <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
  firstname <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
  lastname <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
  reservation_id <span class="hljs-built_in">int</span>,
  no_places <span class="hljs-built_in">int</span>,
  <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>)
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> reservation_type_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">of</span> reservation_type;
</div></code></pre>
<p>Tryp reprezentujący wycieczkę</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> available_trip <span class="hljs-keyword">as</span> <span class="hljs-keyword">OBJECT</span>
(
    trip_id <span class="hljs-built_in">int</span>,
    trip_name <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
    country <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">50</span>),
    trip_date <span class="hljs-built_in">date</span>,
    available_places <span class="hljs-built_in">int</span>
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">type</span> available_trip_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">of</span> available_trip;
</div></code></pre>
<div style="page-break-after: always;"></div>
<h2 id="funkcje-pomocnicze">Funkcje Pomocnicze</h2>
<p>Czy wycieczka istnieje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> trip_exist(trip_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(r.trip_id) <span class="hljs-keyword">into</span> exist
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.trip_id = trip_exist.trip_id;

    if exist = 0 then
        return false;
    else
        return true;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>Czy osoba istnieje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> person_exist(person_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(p.person_id) <span class="hljs-keyword">into</span> exist
    <span class="hljs-keyword">from</span> person p
    <span class="hljs-keyword">where</span> p.person_id = person_exist.person_id;

    if exist = 0 then
        return false;
    else
        return true;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
Czy rezerwacja istnieje
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> reservation_exist(reservation_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(r.reservation_id) <span class="hljs-keyword">into</span> exist
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.reservation_id = reservation_exist.reservation_id;

    if exist = 0 then
        return false;
    else
        return true;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>Czy kraj istnieje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> country_exist(country <span class="hljs-built_in">varchar2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">boolean</span>
<span class="hljs-keyword">as</span>
    exist <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(t.country) <span class="hljs-keyword">into</span> exist
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">where</span> t.country = country_exist.country;

    if exist = 0 then
        return false;
    else
        return true;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<p><a name="available"></a>
Funkcja obliczająca ile jest wolnych miejsc na danej wycieczce.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> available_places(trip_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> <span class="hljs-built_in">int</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> (t.max_no_places - <span class="hljs-keyword">sum</span>(r.no_places)) <span class="hljs-keyword">as</span> amount <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">join</span> reservation r <span class="hljs-keyword">on</span> t.TRIP_ID = r.TRIP_ID
    <span class="hljs-keyword">where</span> t.trip_id = available_places.trip_id <span class="hljs-keyword">and</span> r.STATUS &lt;&gt; <span class="hljs-string">'C'</span>
    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> t.MAX_NO_PLACES;

    return result;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<h2 id="w%C5%82a%C5%9Bciwe-procedury">Właściwe Procedury</h2>
<p>a) Zwraca uczestników wycieczek</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> trip_participants(trip_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> reservation_type_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> reservation_type_table;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> trip_exist(trip_id) <span class="hljs-keyword">then</span>
        raise_application_error(<span class="hljs-number">-20000</span>, <span class="hljs-string">'Trip does not exist'</span>);
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> reservation_type(t.country, t.trip_date, t.name,
       p.firstname, p.lastname, r.reservation_id,
       r.no_places, r.status)
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">join</span> trip t <span class="hljs-keyword">on</span> r.trip_id = t.trip_id
    <span class="hljs-keyword">join</span> person p <span class="hljs-keyword">on</span> r.person_id = p.person_id
    <span class="hljs-keyword">where</span> t.trip_id = trip_participants.trip_id;

    return result;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>b) Zwraca rezerwacje osoby</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> person_reservations(person_id <span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">return</span> reservation_type_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> reservation_type_table;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> person_exist(person_id) <span class="hljs-keyword">then</span>
        raise_application_error(<span class="hljs-number">-20000</span>, <span class="hljs-string">'Person does not exist'</span>);
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> reservation_type(t.country, t.trip_date, t.name,
       p.firstname, p.lastname, r.reservation_id,
       r.no_places, r.status)
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span>
    <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> person p
    <span class="hljs-keyword">join</span> reservation r <span class="hljs-keyword">on</span> p.person_id = r.person_id
    <span class="hljs-keyword">join</span> trip t <span class="hljs-keyword">on</span> t.trip_id = r.trip_id
    <span class="hljs-keyword">where</span> p.person_id = person_reservations.person_id;

    return result;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>c) Zwraca dostępne wycieczki do danego kraju</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> available_trips_to(country <span class="hljs-built_in">varchar2</span>, date_from <span class="hljs-built_in">date</span>, date_to <span class="hljs-built_in">date</span>)
    <span class="hljs-keyword">return</span> available_trip_table
<span class="hljs-keyword">as</span>
    <span class="hljs-keyword">result</span> available_trip_table;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> country_exist(country) <span class="hljs-keyword">then</span>
        raise_application_error(<span class="hljs-number">-20000</span>, <span class="hljs-string">'There is no trip to this destination'</span>);
    ElSIF date_from &gt; date_to then
        raise_application_error(-20000, 'Incorrect date');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">select</span> available_trip(t.trip_id, t.name, t.country, t.trip_date, available_places(t.trip_id))
    <span class="hljs-keyword">bulk</span> <span class="hljs-keyword">collect</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">result</span>
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">where</span> t.country = available_trips_to.COUNTRY <span class="hljs-keyword">and</span>
          t.trip_date <span class="hljs-keyword">between</span> date_from <span class="hljs-keyword">and</span> date_to;

    return result;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<h2 id="5-proceudry-modyfikuj%C4%85ce-dane">5. Proceudry modyfikujące dane</h2>
<h3 id="cz%C4%99%C5%9B%C4%87-kontroli-danych-np-czy-jest-wystarczaj%C4%85co-du%C5%BCo-wolnych-miejsc-zosta%C5%82a-przeniesiona-do-trigger%C3%B3w-w-procedurach-sprawdzamy-tylko-czy-dane-do-kt%C3%B3rych-si%C4%99-odwo%C5%82ujemy-istniej%C4%85">Część kontroli danych (np. czy jest wystarczająco dużo wolnych miejsc) została przeniesiona do <a href="#7-kontrola-dost%C4%99pno%C5%9Bci-miejsc">triggerów</a>. W procedurach sprawdzamy tylko czy dane do których się odwołujemy istnieją.</h3>
<p>a) Procedura dodająca rezerwacje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> add_reservation(trip_id <span class="hljs-built_in">int</span>, person_id <span class="hljs-built_in">int</span>, no_places <span class="hljs-built_in">int</span>)
<span class="hljs-keyword">as</span>
    trip_start <span class="hljs-built_in">date</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> t.trip_date <span class="hljs-keyword">into</span> trip_start
    <span class="hljs-keyword">from</span> TRIP t <span class="hljs-keyword">where</span> t.TRIP_ID = add_reservation.trip_id;

    if not trip_exist(trip_id) then
        RAISE_APPLICATION_ERROR(-20000, 'Trip does not exist');
    elsif not person_exist(person_id) then
        RAISE_APPLICATION_ERROR(-20000, 'Person does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> reservation(trip_id, person_id, <span class="hljs-keyword">status</span>, no_places)
        <span class="hljs-keyword">values</span> (trip_id, person_id, <span class="hljs-string">'n'</span>, no_places);
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>b) Procedura modyfikująca status rezerwacji</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> modify_reservation_status(reservation_id <span class="hljs-built_in">int</span>, <span class="hljs-keyword">status</span> <span class="hljs-built_in">char</span>)
<span class="hljs-keyword">as</span>
    places <span class="hljs-built_in">int</span>;
    trip_id int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> r.no_places, r.trip_id <span class="hljs-keyword">into</span> places, trip_id
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.reservation_id = modify_reservation_status.reservation_id;

    if not reservation_exist(reservation_id) then
        raise_application_error(-20000, 'Reservation does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">update</span> reservation
        <span class="hljs-keyword">set</span> <span class="hljs-keyword">status</span> = modify_reservation_status.status
    <span class="hljs-keyword">where</span> reservation_id = modify_reservation_status.reservation_id;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>c) Procedura modyfikująca ilość zajętych miejsc przez rezerwacje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> modify_reservation(reservation_id <span class="hljs-built_in">int</span>, no_places <span class="hljs-built_in">int</span>)
<span class="hljs-keyword">as</span>
    trip_id <span class="hljs-built_in">int</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> r.trip_id <span class="hljs-keyword">into</span> trip_id
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.reservation_id = modify_reservation.reservation_id;

    if not reservation_exist(trip_id) then
        raise_application_error(-20000, 'Reservation does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">update</span> reservation
        <span class="hljs-keyword">set</span> no_places = modify_reservation.no_places
    <span class="hljs-keyword">where</span> reservation_id = modify_reservation.reservation_id;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>d) Procedura modyfikująca maksymalną ilość miejsc na wycieczce</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">procedure</span> modify_max_places(trip_id <span class="hljs-built_in">int</span>, no_places <span class="hljs-built_in">int</span>)
<span class="hljs-keyword">as</span>
    reserved_places <span class="hljs-built_in">int</span>;
    current_max int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> max_no_places <span class="hljs-keyword">into</span> current_max
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">where</span> t.trip_id = modify_max_places.trip_id;

    reserved_places := current_max - available_places(trip_id);

    if not trip_exist(trip_id) then
        raise_application_error(-20000, 'Trip does not exist');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

    <span class="hljs-keyword">update</span> trip
        <span class="hljs-keyword">set</span> max_no_places = no_places
    <span class="hljs-keyword">where</span> trip_id = modify_max_places.trip_id;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<h2 id="6-triggery-dla-tabeli-log">6. Triggery dla tabeli log</h2>
<p>Tabela log jest opisana w <a href="#tabela-log">punkcie 1.</a></p>
<p>a) Trigger dodający wpis do loga po dodaniu rezerwacji</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> log_add_reservation
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">log</span> (reservation_id, log_date, <span class="hljs-keyword">status</span>, no_places, INFO)
    <span class="hljs-keyword">values</span> (:new.reservation_id, <span class="hljs-keyword">current_date</span>, :new.status, :new.no_places, <span class="hljs-string">'add reservation'</span>);
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>b) c) Triggery dodające wpis do loga po zmodyfikowaniu rezerwacji</p>
<p>Triggery opisane w treści zadania w podpunkcie b) i c) są zrealizowane jako jeden trigger gdyż oba wykonują update na tabeli reservation. W przypadku gdy wywołamy procedurę modify_reservation w taki sposób, że nie zmieni ona żadnych danych w tabeli, to taka operacja nie zostanie zapisana w dzienniku.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> log_modify_reservation
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">update</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span> :new.status &lt;&gt; :old.status <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">log</span> (RESERVATION_ID, LOG_DATE, <span class="hljs-keyword">STATUS</span>, NO_PLACES, INFO)
        <span class="hljs-keyword">values</span> (:new.reservation_id, <span class="hljs-keyword">current_date</span>, :new.status, :new.no_places, <span class="hljs-string">'changed status'</span>);
    elsif :new.no_places &lt;&gt; :old.no_places then
        <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">log</span> (RESERVATION_ID, LOG_DATE, <span class="hljs-keyword">STATUS</span>, NO_PLACES, INFO)
        <span class="hljs-keyword">values</span> (:new.reservation_id, <span class="hljs-keyword">current_date</span>, :new.status, :new.no_places, <span class="hljs-string">'changed no_places'</span>);
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<h2 id="7-kontrola-dost%C4%99pno%C5%9Bci-miejsc">7. Kontrola dostępności miejsc</h2>
<p>a) Trigger sprawdzający czy można dodać nową rezerwacje. Sprawdza czy jest wystarczająco dużo miejsc</p>
<p>Rozsądnie byłoby zablokować możliwość zapisania się na wycieczkę, która już się odbyła. Jednak aby uniknąć problemów z sprawdzaniem poprawności innych procedur, opcja ta została zakomentowana (Być może Pan Dr. ma swój zestaw danych do przetestowania).</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> reservation_add_trigger
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">declare</span>
    trip_start <span class="hljs-built_in">date</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> t.trip_date <span class="hljs-keyword">into</span> trip_start
    <span class="hljs-keyword">from</span> TRIP t <span class="hljs-keyword">where</span> t.TRIP_ID = :new.trip_id;

    if available_places(:new.trip_id) &lt; :new.no_places then
        RAISE_APPLICATION_ERROR(-20000, 'Not enough places');
    elsif current_date &gt; trip_start then
<span class="hljs-comment">--         RAISE_APPLICATION_ERROR(-20000, 'The trip already started');</span>
        DBMS_OUTPUT.PUT_LINE('Uwaga wycieczka juz sie zaczeła');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>b) Trigger sprawdza czy można zmienić status rezerwacji. Ponieważ rezerwacje z statusem 'c' nie wliczają się do
limitu miejsc, trzeba sprawdzić czy po zmianie statusu ilość nie zostanie przekroczona.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> change_status_trigger
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">declare</span>
    places <span class="hljs-built_in">int</span>;
    trip_id int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> r.no_places, r.trip_id <span class="hljs-keyword">into</span> places, trip_id
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.reservation_id = :new.reservation_id;

    if :new.status &lt;&gt; 'c' and places &gt; available_places(:new.trip_id) then
        raise_application_error(-20000, 'Not enough available places');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;

<span class="hljs-keyword">end</span>;
</div></code></pre>
<div style="page-break-after: always;"></div>
<p>c) Trigger sprawdzający czy możemy zmodyfikować ilość miejsc zajętych przez rezerwacje</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> modify_reservation_trigger
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">declare</span>
    trip_id <span class="hljs-built_in">int</span>;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> r.trip_id <span class="hljs-keyword">into</span> trip_id
    <span class="hljs-keyword">from</span> reservation r
    <span class="hljs-keyword">where</span> r.reservation_id = :new.reservation_id;

    if :new.no_places &gt; available_places(trip_id) then
        raise_application_error(-20000,'Not enough places');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
<p>d) Trigger sprawdzający czy można zmodyfikować maksymalną ilość miejsc dla wycieczki. Oczywiście
nie można pozwolić by maksymalna ilość wolnych miejsc była mniejsza od liczby aktualnie zajętych miejsc</p>
<pre class="hljs"><code><div><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">trigger</span> modify_max_places
    <span class="hljs-keyword">before</span> <span class="hljs-keyword">insert</span>
    <span class="hljs-keyword">on</span> RESERVATION
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>
<span class="hljs-keyword">declare</span>
    reserved_places <span class="hljs-built_in">int</span>;
    current_max int;
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">select</span> max_no_places <span class="hljs-keyword">into</span> current_max
    <span class="hljs-keyword">from</span> trip t
    <span class="hljs-keyword">where</span> t.trip_id = :new.trip_id;

    reserved_places := current_max - available_places(:new.trip_id);

    if :new.no_places &lt; reserved_places then
        raise_application_error(-20000,'New max_no_places is lower then ongoing reservations');
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
<span class="hljs-keyword">end</span>;
</div></code></pre>
</font>
</body>
</html>
